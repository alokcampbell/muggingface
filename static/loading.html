<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ full_repo }}</title>
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
    <style>
        * { box-sizing: border-box; }
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f9f9f9;
            color: #333;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }
        .content-wrapper { flex: 1; display: flex; flex-direction: column; }
        main { flex: 1; }
        footer {
            width: 100%;
            background: #eee;
            padding: 1rem;
            font-size: 0.9rem;
            text-align: center;
            border-top: 1px solid #ccc;
            margin-top: auto;
        }
        #p-container {
            width: 100%;
            background-color: #000;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        #p-bar {
            width: 0%;
            height: 20px;
            background-color: red;
            text-align: center;
            color: white;
            line-height: 20px;
            transition: width 0.4s ease;
        }

        #status-message {
            margin: 10px 0;
            font-weight: bold;
            color: #666;
        }
        .loading-container {
            padding: 2rem;
            text-align: center;
        }
    </style>
</head>

<body>
    <div class="content-wrapper">
        <main>
            <div class="loading-container">
                <div id="loading-content">
                    <h1>{{ full_repo }}</h1>
                    <h2>SHA: {{ sha }}</h2>
                    <div id="status-message">Starting download...</div>
                    <div id="p-container">
                        <div id="p-bar">0%</div>
                    </div>
                </div>
            </div>
        </main>
        <footer>
            &copy; made by
            <a href="https://github.com/alokcampbell" target="_blank" rel="noopener">big gerbil</a>
            and
            <a href="https://github.com/djmango" target="_blank" rel="noopener">little gerbil</a>
        </footer>
    </div>

    <script>
        const bar = document.getElementById("p-bar");
        const loadingContent = document.getElementById("loading-content");
        const statusMessage = document.getElementById("status-message");
        let lastProgress = 0;

        console.log("Setting up progress polling...");
        const fullRepo = '{{ full_repo | safe }}';
        const [user, repo] = fullRepo.split('/');
        console.log("Polling for user:", user, "repo:", repo);
        
        const progressUrl = `${window.location.origin}/${user}/${repo}/progress_json`;
        console.log("Polling URL:", progressUrl);

        async function pollProgress() {
            try {
                const response = await fetch(progressUrl);
                const data = await response.json();
                console.log("Progress update:", data);
                
                const progress = (data.downloaded / data.total) * 100;
                bar.style.width = `${progress}%`;
                bar.textContent = `${progress.toFixed(1)}%`;
                lastProgress = progress;

                if (progress < 100) {
                    setTimeout(pollProgress, 1000); 
                } else {
                    window.location.href = `/${user}/${repo}`;
                }
            } catch (error) {
                console.error("Polling error:", error);
                statusMessage.textContent = "Connection error. Please refresh the page.";
            }
        }

        pollProgress();
    </script>
</body>

</html>